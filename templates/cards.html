{% extends "base.html" %}

{% block title %}Cart√µes - BWS Finance{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <div>
        <h1 class="text-3xl font-bold text-gray-800">üí≥ Meus Cart√µes</h1>
        <p class="text-gray-600">Gerencie seus cart√µes de cr√©dito</p>
    </div>
    <button onclick="document.getElementById('addCardModal').classList.remove('hidden')" 
            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
        ‚ûï Novo Cart√£o
    </button>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for card in cards %}
    {% set used = card.used_limit or 0 %}
    {% set limit = card.limit_amount or 0 %}
    {% set available = limit - used %}
    {% set percent = (used / limit * 100) if limit > 0 else 0 %}
    {% if percent < 50 %}
        {% set color_class = "bg-green-500" %}
        {% set text_color = "text-green-600" %}
    {% elif percent < 80 %}
        {% set color_class = "bg-yellow-500" %}
        {% set text_color = "text-yellow-600" %}
    {% else %}
        {% set color_class = "bg-red-500" %}
        {% set text_color = "text-red-600" %}
    {% endif %}
    
    <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg shadow-lg p-6 text-white hover:shadow-xl transition">
        <div class="flex justify-between items-start mb-8">
            <div>
                <p class="text-sm opacity-75">{{ card.brand or 'Cart√£o' }}</p>
                <h3 class="text-xl font-bold">{{ card.name }}</h3>
            </div>
            <div class="flex gap-2">
                <button onclick="openEditCardModal('{{ card.id }}', '{{ card.name }}', '{{ card.brand }}', '{{ card.last_digits }}', {{ card.limit_amount }}, {{ card.closing_day }}, {{ card.due_day }}, '{{ card.account_id }}')" 
                        class="text-white hover:text-yellow-400 transition">
                    ‚úèÔ∏è
                </button>
                <span class="text-2xl">üí≥</span>
            </div>
        </div>
        
        <div class="mb-4">
            <p class="text-sm opacity-75">N√∫mero</p>
            <p class="text-lg font-mono">**** **** **** {{ card.last_digits or '****' }}</p>
        </div>
        
        <!-- Barra de Progresso do Limite -->
        <div class="mb-4">
            <div class="flex justify-between text-xs mb-1">
                <span class="opacity-75">Usado: R$ {{ "%.2f"|format(used) }}</span>
                <span class="opacity-75">{{ "%.0f"|format(percent) }}%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2 mb-2">
                <div class="{{ color_class }} h-2 rounded-full transition-all" style="width: {{ percent }}%"></div>
            </div>
            <p class="text-sm font-semibold">
                Dispon√≠vel: <span class="{{ text_color }}">R$ {{ "%.2f"|format(available) }}</span>
            </p>
        </div>
        
        <div class="border-t border-gray-700 pt-4 grid grid-cols-2 gap-4">
            <div>
                <p class="text-xs opacity-75">Limite Total</p>
                <p class="font-semibold">R$ {{ "%.2f"|format(limit) }}</p>
            </div>
            <div>
                <p class="text-xs opacity-75">Vencimento</p>
                <p class="font-semibold">Dia {{ card.due_day }}</p>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-span-full text-center py-12 text-gray-500">
        Nenhum cart√£o cadastrado. Clique em "Novo Cart√£o" para adicionar.
    </div>
    {% endfor %}
</div>

<!-- Modal Adicionar Cart√£o -->
<div id="addCardModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Novo Cart√£o</h2>
            <button onclick="document.getElementById('addCardModal').classList.add('hidden')" 
                    class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        
        <form method="POST" action="{{ url_for('add_card') }}">
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Conta Vinculada</label>
                <select name="account_id" required class="w-full border rounded px-3 py-2">
                    {% for account in accounts %}
                    <option value="{{ account.id }}">{{ account.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Nome do Cart√£o</label>
                <input type="text" name="name" required 
                       placeholder="Ex: Nubank Gold, Inter"
                       class="w-full border rounded px-3 py-2">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Bandeira</label>
                <select name="brand" class="w-full border rounded px-3 py-2">
                    <option value="Visa">Visa</option>
                    <option value="Mastercard">Mastercard</option>
                    <option value="Elo">Elo</option>
                    <option value="Amex">American Express</option>
                    <option value="Hipercard">Hipercard</option>
                    <option value="Outro">Outro</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">4 √öltimos D√≠gitos</label>
                <input type="text" name="last_digits" maxlength="4" pattern="[0-9]{4}"
                       placeholder="1234"
                       class="w-full border rounded px-3 py-2">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Limite (R$)</label>
                <input type="number" name="limit_amount" step="0.01" value="0"
                       class="w-full border rounded px-3 py-2">
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-gray-700 mb-2">Dia Fechamento</label>
                    <input type="number" name="closing_day" min="1" max="31" required
                           placeholder="15"
                           class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">Dia Vencimento</label>
                    <input type="number" name="due_day" min="1" max="31" required
                           placeholder="10"
                           class="w-full border rounded px-3 py-2">
                </div>
            </div>
            
            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold">
                Adicionar Cart√£o
            </button>
        </form>
    </div>
</div>

<!-- Modal Editar Cart√£o -->
<div id="editCardModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Editar Cart√£o</h2>
            <button onclick="closeEditCardModal()" 
                    class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        
        <form method="POST" action="/cards/edit" id="editCardForm">
            <input type="hidden" name="card_id" id="edit_card_id">
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Conta Vinculada</label>
                <select name="account_id" id="edit_account_id" required class="w-full border rounded px-3 py-2">
                    {% for account in accounts %}
                    <option value="{{ account.id }}">{{ account.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Nome do Cart√£o</label>
                <input type="text" name="name" id="edit_name" required 
                       placeholder="Ex: Nubank Gold, Inter"
                       class="w-full border rounded px-3 py-2">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Bandeira</label>
                <select name="brand" id="edit_brand" class="w-full border rounded px-3 py-2">
                    <option value="Visa">Visa</option>
                    <option value="Mastercard">Mastercard</option>
                    <option value="Elo">Elo</option>
                    <option value="Amex">American Express</option>
                    <option value="Hipercard">Hipercard</option>
                    <option value="Outro">Outro</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">4 √öltimos D√≠gitos</label>
                <input type="text" name="last_digits" id="edit_last_digits" maxlength="4" pattern="[0-9]{4}"
                       placeholder="1234"
                       class="w-full border rounded px-3 py-2">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Limite (R$)</label>
                <input type="number" name="limit_amount" id="edit_limit_amount" step="0.01"
                       class="w-full border rounded px-3 py-2">
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-gray-700 mb-2">Dia Fechamento</label>
                    <input type="number" name="closing_day" id="edit_closing_day" min="1" max="31" required
                           class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">Dia Vencimento</label>
                    <input type="number" name="due_day" id="edit_due_day" min="1" max="31" required
                           class="w-full border rounded px-3 py-2">
                </div>
            </div>
            
            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold">
                Salvar Altera√ß√µes
            </button>
        </form>
    </div>
</div>

<script>
function openEditCardModal(cardId, name, brand, lastDigits, limitAmount, closingDay, dueDay, accountId) {
    document.getElementById('edit_card_id').value = cardId;
    document.getElementById('edit_name').value = name;
    document.getElementById('edit_brand').value = brand;
    document.getElementById('edit_last_digits').value = lastDigits;
    document.getElementById('edit_limit_amount').value = limitAmount;
    document.getElementById('edit_closing_day').value = closingDay;
    document.getElementById('edit_due_day').value = dueDay;
    document.getElementById('edit_account_id').value = accountId;
    document.getElementById('editCardModal').classList.remove('hidden');
}

function closeEditCardModal() {
    document.getElementById('editCardModal').classList.add('hidden');
}
</script>
{% endblock %}
