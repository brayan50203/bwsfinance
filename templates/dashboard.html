{% extends "base.html" %}

{% block title %}Dashboard - BWS Finance{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-800">📊 Dashboard Financeiro</h1>
    <p class="text-gray-600">Visão geral das suas finanças</p>
</div>

<!-- Filtros -->
<div class="bg-white p-4 rounded-lg shadow mb-6">
    <form method="GET" class="flex gap-4">
        <div>
            <label class="block text-sm text-gray-700 mb-1">Ano</label>
            <select name="year" class="border rounded px-3 py-2">
                {% for period in periods %}
                    <option value="{{ period.year }}" {% if period.year == current_year|string %}selected{% endif %}>{{ period.year }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-sm text-gray-700 mb-1">Mês</label>
            <select name="month" class="border rounded px-3 py-2">
                {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if m == current_month %}selected{% endif %}>{{ m }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="flex items-end">
            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                Filtrar
            </button>
        </div>
    </form>
</div>

<!-- Cards de Resumo -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Investimentos -->
    <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 p-6 rounded-lg shadow-lg text-white">
        <div class="flex justify-between items-start mb-2">
            <div class="flex-1">
                <p class="text-indigo-100 text-sm">📈 Investimentos</p>
                <p class="text-3xl font-bold">R$ {{ "%.2f"|format(investments_summary.total_current) }}</p>
                <div class="mt-2 flex items-center gap-2">
                    {% if investments_summary.profit_percent >= 0 %}
                        <span class="text-sm bg-green-400 bg-opacity-30 px-2 py-1 rounded">
                            +{{ "%.2f"|format(investments_summary.profit_percent) }}%
                        </span>
                    {% else %}
                        <span class="text-sm bg-red-400 bg-opacity-30 px-2 py-1 rounded">
                            {{ "%.2f"|format(investments_summary.profit_percent) }}%
                        </span>
                    {% endif %}
                    <span class="text-xs text-indigo-200">
                        R$ {{ "%.2f"|format(investments_summary.profit_loss) }}
                    </span>
                </div>
                {% if investments_summary.last_update %}
                <p class="text-xs text-indigo-200 mt-2">
                    Última atualização: {{ investments_summary.last_update[:16] }}
                </p>
                {% endif %}
            </div>
            <button onclick="updateInvestments()" 
                    id="updateInvestmentsBtn"
                    class="bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded transition"
                    title="Atualizar cotações">
                🔄
            </button>
        </div>
        <a href="{{ url_for('investments_page') }}" class="text-sm text-indigo-100 hover:text-white underline">
            Ver todos os {{ investments_summary.total_investments }} investimentos →
        </a>
    </div>
    
    <!-- Renda Fixa -->
    <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-lg shadow-lg text-white">
        <div class="flex justify-between items-start mb-2">
            <div>
                <p class="text-green-100 text-sm">💼 Renda Fixa</p>
                <p class="text-3xl font-bold">R$ {{ "%.2f"|format(summary.renda_fixa) }}</p>
            </div>
        </div>
    </div>
    
    <!-- Renda Variável -->
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-lg shadow-lg text-white">
        <div class="flex justify-between items-start mb-2">
            <div>
                <p class="text-blue-100 text-sm">💻 Renda Variável</p>
                <p class="text-3xl font-bold">R$ {{ "%.2f"|format(summary.renda_variavel) }}</p>
            </div>
        </div>
    </div>
    
    <!-- Renda Total -->
    <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 p-6 rounded-lg shadow-lg text-white">
        <div class="flex justify-between items-start mb-2">
            <div>
                <p class="text-emerald-100 text-sm">💰 Renda Total</p>
                <p class="text-3xl font-bold">R$ {{ "%.2f"|format(summary.renda_total) }}</p>
            </div>
        </div>
    </div>
    
    <!-- Custo Fixo -->
    <div class="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-lg shadow-lg text-white">
        <div class="flex justify-between items-start mb-2">
            <div>
                <p class="text-red-100 text-sm">🏠 Custo Fixo</p>
                <p class="text-3xl font-bold">R$ {{ "%.2f"|format(summary.custo_fixo) }}</p>
            </div>
        </div>
    </div>
    
    <!-- Custo Variável -->
    <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-6 rounded-lg shadow-lg text-white">
        <div class="flex justify-between items-start mb-2">
            <div>
                <p class="text-orange-100 text-sm">🛒 Custo Variável</p>
                <p class="text-3xl font-bold">R$ {{ "%.2f"|format(summary.custo_variavel) }}</p>
            </div>
        </div>
    </div>
    
    <!-- Saldo Mensal -->
    <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-lg shadow-lg text-white">
        <div class="flex justify-between items-start mb-2">
            <div>
                <p class="text-purple-100 text-sm">📊 Saldo Mensal</p>
                <p class="text-3xl font-bold">R$ {{ "%.2f"|format(summary.saldo_mensal) }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Botão Adicionar -->
<div class="mb-6">
    <button onclick="document.getElementById('addModal').classList.remove('hidden')" 
            class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold">
        ➕ Adicionar Transação
    </button>
</div>

<!-- Card de Próximas Parcelas -->
{% if upcoming_installments %}
<div class="bg-gradient-to-r from-yellow-500 to-orange-500 rounded-lg shadow-xl p-6 mb-6 text-white">
    <div class="flex justify-between items-center mb-4">
        <div>
            <h2 class="text-2xl font-bold">💳 Próximas Parcelas</h2>
            <p class="text-yellow-100">Vencendo nos próximos 30 dias</p>
        </div>
        <a href="{{ url_for('installments_page') }}" class="bg-white text-orange-600 px-4 py-2 rounded-lg font-semibold hover:bg-yellow-50 transition duration-200">
            Ver Todos
        </a>
    </div>
    
    <div class="space-y-3">
        {% for inst in upcoming_installments %}
        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4 hover:bg-white/20 transition duration-200">
            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <p class="font-semibold text-lg">{{ inst.installment_description }}</p>
                    <p class="text-yellow-100 text-sm">
                        Parcela {{ inst.installment_number }}/{{ inst.installment_count }} - Vencimento: {{ inst.due_date }}
                    </p>
                </div>
                <div class="text-right">
                    <p class="text-2xl font-bold">R$ {{ "%.2f"|format(inst.value) }}</p>
                    <a href="{{ url_for('installment_details', installment_id=inst.installment_id) }}" 
                       class="text-sm text-yellow-100 hover:text-white underline">
                        Ver Detalhes →
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Gráficos -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Gráfico: Distribuição de Custos por Categoria -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">📊 Distribuição de Custos</h3>
        <div style="height: 300px; position: relative;">
            <canvas id="costosChart"></canvas>
        </div>
    </div>
    
    <!-- Gráfico: Evolução Mensal (Renda vs Custos) -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">📈 Evolução Mensal</h3>
        <div style="height: 300px; position: relative;">
            <canvas id="evolucaoChart"></canvas>
        </div>
    </div>
</div>

<!-- Tabelas -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Rendas -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">💰 Rendas</h2>
            <a href="{{ url_for('all_transactions') }}" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                Ver todas →
            </a>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Descrição</th>
                        <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Valor</th>
                        <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Tipo</th>
                        <th class="px-4 py-2 text-center text-sm font-semibold text-gray-700">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for renda in rendas %}
                    <tr class="border-t hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                {% if renda.category_icon %}<span>{{ renda.category_icon }}</span>{% endif %}
                                <div>
                                    <p class="font-medium">{{ renda.description }}</p>
                                    <p class="text-xs text-gray-500">{{ renda.date }}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-green-600 font-semibold">R$ {{ "%.2f"|format(renda.value) }}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs rounded {% if renda.is_fixed %}bg-blue-100 text-blue-700{% else %}bg-purple-100 text-purple-700{% endif %}">
                                {% if renda.is_fixed %}Fixa{% else %}Variável{% endif %}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="editTransaction('{{ renda.id }}', '{{ renda.description }}', '{{ renda.value }}', '{{ renda.type }}', '{{ renda.date }}', '{{ renda.account_id }}', '{{ renda.category_id }}', {{ renda.is_fixed|tojson }}, '{{ renda.card_id or '' }}')" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">✏️</button>
                            <form method="POST" action="{{ url_for('delete_transaction', transaction_id=renda.id) }}" style="display:inline;">
                                <button type="submit" class="text-red-600 hover:text-red-800" onclick="return confirm('Excluir esta transação?')" title="Excluir">🗑️</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="px-4 py-8 text-center text-gray-500">Nenhuma renda neste período</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Custos -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">💸 Custos</h2>
            <a href="{{ url_for('all_transactions') }}" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                Ver todas →
            </a>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Descrição</th>
                        <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Valor</th>
                        <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Tipo</th>
                        <th class="px-4 py-2 text-center text-sm font-semibold text-gray-700">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for custo in custos %}
                    <tr class="border-t hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                {% if custo.category_icon %}<span>{{ custo.category_icon }}</span>{% endif %}
                                <div>
                                    <p class="font-medium">{{ custo.description }}</p>
                                    <p class="text-xs text-gray-500">{{ custo.date }}{% if custo.card_name %} | 💳 {{ custo.card_name }}{% endif %}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-red-600 font-semibold">R$ {{ "%.2f"|format(custo.value) }}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs rounded {% if custo.is_fixed %}bg-red-100 text-red-700{% else %}bg-orange-100 text-orange-700{% endif %}">
                                {% if custo.is_fixed %}Fixo{% else %}Variável{% endif %}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="editTransaction('{{ custo.id }}', '{{ custo.description }}', '{{ custo.value }}', '{{ custo.type }}', '{{ custo.date }}', '{{ custo.account_id }}', '{{ custo.category_id }}', {{ custo.is_fixed|tojson }}, '{{ custo.card_id or '' }}')" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">✏️</button>
                            <form method="POST" action="{{ url_for('delete_transaction', transaction_id=custo.id) }}" style="display:inline;">
                                <button type="submit" class="text-red-600 hover:text-red-800" onclick="return confirm('Excluir esta transação?')" title="Excluir">🗑️</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="px-4 py-8 text-center text-gray-500">Nenhum custo neste período</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Adicionar Transação -->
<div id="addModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Adicionar Transação</h2>
            <button onclick="document.getElementById('addModal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        
        <form method="POST" action="{{ url_for('add_transaction') }}">
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Conta</label>
                <select name="account_id" required class="w-full border rounded px-3 py-2">
                    {% for account in accounts %}
                    <option value="{{ account.id }}">{{ account.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Tipo</label>
                <select name="type" id="transactionType" required class="w-full border rounded px-3 py-2" onchange="filterCategories()">
                    <option value="Receita">💰 Receita</option>
                    <option value="Despesa">💸 Despesa</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Categoria</label>
                <select name="category_id" id="categorySelect" required class="w-full border rounded px-3 py-2">
                    <option value="">Selecione uma categoria</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" data-type="{{ category.type }}" data-icon="{{ category.icon }}">
                        {{ category.icon }} {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Descrição</label>
                <input type="text" name="description" required class="w-full border rounded px-3 py-2">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Valor (R$)</label>
                <input type="number" name="value" step="0.01" required class="w-full border rounded px-3 py-2">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Data</label>
                <input type="date" name="date" required class="w-full border rounded px-3 py-2">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Método de Pagamento</label>
                <select name="payment_method" id="paymentMethod" class="w-full border rounded px-3 py-2" onchange="toggleCardField()">
                    <option value="debito">💳 Débito</option>
                    <option value="credito">💳 Crédito</option>
                    <option value="dinheiro">💵 Dinheiro</option>
                    <option value="pix">📱 PIX</option>
                    <option value="outro">🔄 Outro</option>
                </select>
            </div>
            
            <div id="cardField" class="mb-4 hidden">
                <label class="block text-gray-700 mb-2">Cartão de Crédito</label>
                <select name="card_id" id="cardSelect" class="w-full border rounded px-3 py-2">
                    <option value="">Selecione um cartão</option>
                    {% for card in cards %}
                    <option value="{{ card.id }}">
                        🏦 {{ card.name }} - Limite disponível: R$ {{ "%.2f"|format(card.limit_amount - (card.used_limit or 0)) }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div id="installmentField" class="mb-4 hidden">
                <label class="block text-gray-700 mb-2">💳 Parcelar em quantas vezes?</label>
                <select name="installments" id="installmentsSelect" class="w-full border rounded px-3 py-2">
                    <option value="1">1x (à vista)</option>
                    <option value="2">2x sem juros</option>
                    <option value="3">3x sem juros</option>
                    <option value="4">4x sem juros</option>
                    <option value="5">5x sem juros</option>
                    <option value="6">6x sem juros</option>
                    <option value="7">7x sem juros</option>
                    <option value="8">8x sem juros</option>
                    <option value="9">9x sem juros</option>
                    <option value="10">10x sem juros</option>
                    <option value="11">11x sem juros</option>
                    <option value="12">12x sem juros</option>
                </select>
            </div>
            
            <div class="mb-6">
                <label class="flex items-center">
                    <input type="checkbox" name="is_fixed" class="mr-2">
                    <span class="text-gray-700">É fixa/recorrente?</span>
                </label>
            </div>
            
            <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-semibold">
                Adicionar
            </button>
        </form>
    </div>
</div>

<!-- Modal Editar Transação -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Editar Transação</h2>
            <button onclick="document.getElementById('editModal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        
        <form method="POST" action="/transactions/edit" id="editForm">
            <input type="hidden" name="transaction_id" id="editTransactionId">
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Conta</label>
                <select name="account_id" id="editAccountId" required class="w-full border rounded px-3 py-2">
                    {% for account in accounts %}
                    <option value="{{ account.id }}">{{ account.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Tipo</label>
                <select name="type" id="editTransactionType" required class="w-full border rounded px-3 py-2" onchange="filterEditCategories()">
                    <option value="Receita">💰 Receita</option>
                    <option value="Despesa">💸 Despesa</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Categoria</label>
                <select name="category_id" id="editCategorySelect" required class="w-full border rounded px-3 py-2">
                    <option value="">Selecione uma categoria</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" data-type="{{ category.type }}" data-icon="{{ category.icon }}">
                        {{ category.icon }} {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Descrição</label>
                <input type="text" name="description" id="editDescription" required class="w-full border rounded px-3 py-2">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Valor (R$)</label>
                <input type="number" name="value" id="editValue" step="0.01" required class="w-full border rounded px-3 py-2">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Data</label>
                <input type="date" name="date" id="editDate" required class="w-full border rounded px-3 py-2">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Método de Pagamento</label>
                <select name="payment_method" id="editPaymentMethod" class="w-full border rounded px-3 py-2" onchange="toggleEditCardField()">
                    <option value="debito">💳 Débito</option>
                    <option value="credito">💳 Crédito</option>
                    <option value="dinheiro">💵 Dinheiro</option>
                    <option value="pix">📱 PIX</option>
                    <option value="outro">🔄 Outro</option>
                </select>
            </div>
            
            <div id="editCardField" class="mb-4 hidden">
                <label class="block text-gray-700 mb-2">Cartão de Crédito</label>
                <select name="card_id" id="editCardSelect" class="w-full border rounded px-3 py-2">
                    <option value="">Selecione um cartão</option>
                    {% for card in cards %}
                    <option value="{{ card.id }}">
                        🏦 {{ card.name }} - Limite disponível: R$ {{ "%.2f"|format(card.limit_amount - (card.used_limit or 0)) }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-6">
                <label class="flex items-center">
                    <input type="checkbox" name="is_fixed" id="editIsFixed" class="mr-2">
                    <span class="text-gray-700">É fixa/recorrente?</span>
                </label>
            </div>
            
            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold">
                Salvar Alterações
            </button>
        </form>
    </div>
</div>

<script>
// Filtrar categorias por tipo de transação
function filterCategories() {
    const type = document.getElementById('transactionType').value;
    const categorySelect = document.getElementById('categorySelect');
    const options = categorySelect.querySelectorAll('option');
    
    options.forEach(option => {
        if (option.value === '') {
            option.style.display = 'block';
            return;
        }
        
        const optionType = option.getAttribute('data-type');
        if (optionType === type) {
            option.style.display = 'block';
        } else {
            option.style.display = 'none';
        }
    });
    
    // Reset seleção
    categorySelect.value = '';
}

// Filtrar categorias ao abrir o modal
document.querySelector('[onclick*="addModal"]')?.addEventListener('click', function() {
    setTimeout(filterCategories, 100);
});

// Mostrar/ocultar campo de cartão baseado no método de pagamento
function toggleCardField() {
    const paymentMethod = document.getElementById('paymentMethod').value;
    const cardField = document.getElementById('cardField');
    const cardSelect = document.getElementById('cardSelect');
    const installmentField = document.getElementById('installmentField');
    
    if (paymentMethod === 'credito') {
        cardField.classList.remove('hidden');
        cardSelect.required = true;
        installmentField.classList.remove('hidden');
    } else {
        cardField.classList.add('hidden');
        cardSelect.required = false;
        cardSelect.value = '';
        installmentField.classList.add('hidden');
        document.getElementById('installmentsSelect').value = '1';
    }
}

// Inicializar toggle ao abrir modal
document.querySelector('[onclick*="addModal"]')?.addEventListener('click', function() {
    setTimeout(() => {
        filterCategories();
        toggleCardField();
    }, 100);
});

// Função para editar transação
function editTransaction(id, description, value, type, date, accountId, categoryId, isFixed, cardId) {
    // Preencher os campos do modal de edição
    document.getElementById('editTransactionId').value = id;
    document.getElementById('editDescription').value = description;
    document.getElementById('editValue').value = value;
    document.getElementById('editTransactionType').value = type;
    document.getElementById('editDate').value = date;
    document.getElementById('editAccountId').value = accountId;
    document.getElementById('editCategorySelect').value = categoryId;
    document.getElementById('editIsFixed').checked = isFixed;
    
    // Se tiver cartão, selecionar e mostrar campo
    if (cardId) {
        document.getElementById('editPaymentMethod').value = 'credito';
        document.getElementById('editCardSelect').value = cardId;
        toggleEditCardField();
    } else {
        document.getElementById('editPaymentMethod').value = 'debito';
    }
    
    // Filtrar categorias
    filterEditCategories();
    
    // Mostrar modal
    document.getElementById('editModal').classList.remove('hidden');
}

// Filtrar categorias no modal de edição
function filterEditCategories() {
    const type = document.getElementById('editTransactionType').value;
    const categorySelect = document.getElementById('editCategorySelect');
    const options = categorySelect.querySelectorAll('option');
    
    options.forEach(option => {
        if (option.value === '') {
            option.style.display = 'block';
            return;
        }
        
        const optionType = option.getAttribute('data-type');
        if (optionType === type) {
            option.style.display = 'block';
        } else {
            option.style.display = 'none';
        }
    });
}

// Toggle campo de cartão no modal de edição
function toggleEditCardField() {
    const paymentMethod = document.getElementById('editPaymentMethod').value;
    const cardField = document.getElementById('editCardField');
    const cardSelect = document.getElementById('editCardSelect');
    
    if (paymentMethod === 'credito') {
        cardField.classList.remove('hidden');
        cardSelect.required = true;
    } else {
        cardField.classList.add('hidden');
        cardSelect.required = false;
        cardSelect.value = '';
    }
}

// Função para atualizar investimentos
async function updateInvestments() {
    const btn = document.getElementById('updateInvestmentsBtn');
    const originalContent = btn.innerHTML;
    
    // Mostrar loading
    btn.innerHTML = '⏳';
    btn.disabled = true;
    
    try {
        const response = await fetch('/investments/update-quotes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Mostrar sucesso
            btn.innerHTML = '✅';
            
            // Recarregar página após 1 segundo
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            alert('Erro ao atualizar investimentos: ' + (data.error || 'Erro desconhecido'));
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao atualizar investimentos. Verifique o console.');
        btn.innerHTML = originalContent;
        btn.disabled = false;
    }
}

// ==================== GRÁFICOS COM CHART.JS ====================

// Dados para os gráficos (passados do backend)
const costosData = {{ custos_por_categoria|tojson }};
const evolucaoData = {{ evolucao_mensal|tojson }};

// Gráfico 1: Distribuição de Custos (Pizza/Donut)
if (document.getElementById('costosChart')) {
    const ctx1 = document.getElementById('costosChart').getContext('2d');
    
    // Preparar dados
    const labels = Object.keys(costosData);
    const valores = Object.values(costosData);
    const total = valores.reduce((a, b) => a + b, 0);
    
    new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: valores,
                backgroundColor: [
                    '#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', 
                    '#ef4444', '#ec4899', '#14b8a6', '#6366f1',
                    '#a855f7', '#f97316', '#06b6d4', '#84cc16'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            aspectRatio: 1,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 10,
                        font: { size: 11 },
                        boxWidth: 15,
                        boxHeight: 15,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return {
                                        text: `${label}: R$ ${value.toFixed(2)} (${percent}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        hidden: false,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${label}: R$ ${value.toFixed(2)} (${percent}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Gráfico 2: Evolução Mensal (Linha)
if (document.getElementById('evolucaoChart')) {
    const ctx2 = document.getElementById('evolucaoChart').getContext('2d');
    
    const meses = evolucaoData.map(d => d.mes);
    const rendas = evolucaoData.map(d => d.renda);
    const custos = evolucaoData.map(d => d.custo);
    const saldos = evolucaoData.map(d => d.saldo);
    
    new Chart(ctx2, {
        type: 'line',
        data: {
            labels: meses,
            datasets: [
                {
                    label: 'Renda',
                    data: rendas,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Custos',
                    data: custos,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Saldo',
                    data: saldos,
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    borderDash: [5, 5]
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            aspectRatio: 2,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        padding: 15,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': R$ ' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toFixed(0);
                        }
                    }
                }
            }
        }
    });
}
</script>

<!-- Botão Flutuante da IA -->
<div id="ai-floating-button" class="fixed bottom-6 right-6 z-50">
    <button onclick="toggleAIChat()" id="ai-button" class="relative bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white p-4 rounded-full shadow-2xl transition-all duration-300 transform hover:scale-110">
        <svg id="ai-icon-message" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
        </svg>
        <svg id="ai-icon-close" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        <span class="absolute top-0 right-0 w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
    </button>
</div>

<!-- Painel de Chat da IA -->
<div id="ai-chat-panel" class="fixed bottom-24 right-6 w-96 max-w-[calc(100vw-3rem)] bg-white rounded-2xl shadow-2xl z-50 hidden transform transition-all duration-300 ease-out">
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 rounded-t-2xl flex items-center gap-3">
        <div class="relative">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            <svg class="w-4 h-4 text-yellow-300 absolute -top-1 -right-1" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
            </svg>
        </div>
        <div class="flex-1">
            <h3 class="text-white font-bold">BWS Insight AI</h3>
            <p class="text-indigo-100 text-xs">Assistente Financeiro</p>
        </div>
    </div>
    
    <div id="ai-messages" class="h-96 overflow-y-auto p-4 space-y-4">
        <div class="flex gap-3 justify-start">
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
            </div>
            <div class="max-w-[75%] bg-gray-100 rounded-2xl px-4 py-3">
                <p class="text-sm text-gray-800">👋 Olá! Sou o <strong>BWS Insight AI</strong>, seu assistente financeiro pessoal.</p>
                <p class="text-sm text-gray-800 mt-2">Posso te ajudar com:</p>
                <ul class="text-sm text-gray-800 mt-1 list-disc list-inside">
                    <li>💰 Consultar saldo e transações</li>
                    <li>📊 Analisar gastos por categoria</li>
                    <li>📈 Verificar investimentos</li>
                    <li>🔮 Fazer previsões financeiras</li>
                </ul>
                <p class="text-sm text-gray-800 mt-2">Como posso ajudar?</p>
            </div>
        </div>
    </div>
    
    <div class="p-4 border-t border-gray-200">
        <div class="flex gap-2">
            <input type="text" id="ai-input" placeholder="Digite sua pergunta..." class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button onclick="sendAIMessage()" class="px-4 py-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
function toggleAIChat() {
    const panel = document.getElementById('ai-chat-panel');
    const button = document.getElementById('ai-button');
    const iconMessage = document.getElementById('ai-icon-message');
    const iconClose = document.getElementById('ai-icon-close');
    
    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        button.classList.remove('from-purple-600', 'to-indigo-600');
        button.classList.add('bg-red-600', 'hover:bg-red-700');
        iconMessage.classList.add('hidden');
        iconClose.classList.remove('hidden');
    } else {
        panel.classList.add('hidden');
        button.classList.add('from-purple-600', 'to-indigo-600');
        button.classList.remove('bg-red-600', 'hover:bg-red-700');
        iconMessage.classList.remove('hidden');
        iconClose.classList.add('hidden');
    }
}

async function sendAIMessage() {
    const input = document.getElementById('ai-input');
    const messagesContainer = document.getElementById('ai-messages');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Adicionar mensagem do usuário
    const userMessageDiv = document.createElement('div');
    userMessageDiv.className = 'flex gap-3 justify-end';
    userMessageDiv.innerHTML = `
        <div class="max-w-[75%] bg-indigo-600 text-white rounded-2xl px-4 py-3">
            <p class="text-sm">${escapeHtml(message)}</p>
        </div>
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
        </div>
    `;
    messagesContainer.appendChild(userMessageDiv);
    input.value = '';
    
    // Loading indicator
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'flex gap-3 justify-start';
    loadingDiv.id = 'ai-loading';
    loadingDiv.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-white animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
        <div class="bg-gray-100 rounded-2xl px-4 py-3">
            <div class="flex gap-1">
                <div class="w-2 h-2 bg-indigo-600 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-indigo-600 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-2 h-2 bg-indigo-600 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
        </div>
    `;
    messagesContainer.appendChild(loadingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    try {
        const response = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ message: message })
        });
        
        const data = await response.json();
        
        // Remover loading
        document.getElementById('ai-loading').remove();
        
        if (data.success) {
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.className = 'flex gap-3 justify-start';
            aiMessageDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <div class="max-w-[75%] bg-gray-100 rounded-2xl px-4 py-3">
                    <div class="text-sm text-gray-800 prose prose-sm">${formatMarkdown(data.ai_response)}</div>
                </div>
            `;
            messagesContainer.appendChild(aiMessageDiv);
        } else {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'flex gap-3 justify-start';
            errorDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-red-500 flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="max-w-[75%] bg-red-100 rounded-2xl px-4 py-3">
                    <p class="text-sm text-red-800">❌ Erro: ${escapeHtml(data.error || 'Não foi possível processar sua mensagem.')}</p>
                </div>
            `;
            messagesContainer.appendChild(errorDiv);
        }
    } catch (error) {
        document.getElementById('ai-loading').remove();
        const errorDiv = document.createElement('div');
        errorDiv.className = 'flex gap-3 justify-start';
        errorDiv.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-red-500 flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <div class="max-w-[75%] bg-red-100 rounded-2xl px-4 py-3">
                <p class="text-sm text-red-800">⚠️ Erro de conexão. Verifique se o servidor está rodando.</p>
            </div>
        `;
        messagesContainer.appendChild(errorDiv);
    }
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatMarkdown(text) {
    // Simples formatação de Markdown para HTML
    return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>')
        .replace(/• /g, '&bull; ');
}

// Enter key para enviar
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('ai-input');
    if (input) {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendAIMessage();
            }
        });
    }
});
</script>
{% endblock %}




